################################################################################
# Build AL-Go Runner Image
#
# Creates a minimal Windows 2022 image optimized for Business Central AL-Go
# workflows with pre-cached BC containers and artifacts.
#
# Target: ~35-40GB (vs 100GB+ full runner-images)
# BC container startup: <2 min (vs 30-45 min)
################################################################################

name: Build AL-Go Runner Image

on:
  workflow_dispatch:
    inputs:
      skip_bc_cache:
        description: 'Skip BC caching (faster builds for testing)'
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      bc_type:
        description: 'BC artifact type'
        default: 'Sandbox'
        type: choice
        options:
          - Sandbox
          - OnPrem
      bc_country:
        description: 'BC country code'
        default: 'us'
        type: string
      bc_select:
        description: 'BC version selection'
        default: 'Latest'
        type: choice
        options:
          - Latest
          - Current
          - Daily
          - NextMajor
          - NextMinor

# Minimal global permissions
permissions:
  contents: read

# Prevent duplicate runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PACKER_VERSION: '1.10.0'
  IMAGE_OS: 'win22'
  TEMPLATE_PATH: 'images/windows/templates'
  BUILD_TEMPLATE: 'build.windows-2022-algo.pkr.hcl'

jobs:
  # ============================================================================
  # Job 1: Build Managed Image with Packer
  # ============================================================================
  build-image:
    name: Build Managed Image
    runs-on: self-hosted
    timeout-minutes: 180  # 3 hours max for Windows image build
    outputs:
      image_name: ${{ steps.names.outputs.image_name }}
      image_version: ${{ steps.names.outputs.image_version }}
      temp_rg_name: ${{ steps.names.outputs.temp_rg_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      # ========================================================================
      # Security: Mask sensitive patterns in Packer output
      # ========================================================================
      - name: Setup output masking
        id: masking
        shell: pwsh
        run: |
          # Mask patterns that could leak infrastructure details
          # These are dynamically generated during build and appear in Packer logs
          Write-Host "Setting up output masking for security..."

          # Mask Key Vault URL patterns (vault.azure.net secrets)
          # Example: https://pkrkv*.vault.azure.net/secrets/*
          Write-Host "::add-mask::vault.azure.net"

          # Get the runner's public IP and mask it
          # This prevents exposing the build VM's IP address in logs
          try {
            $publicIp = (Invoke-RestMethod -Uri 'https://api.ipify.org' -TimeoutSec 10)
            if ($publicIp -match '^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$') {
              Write-Host "::add-mask::$publicIp"
              Write-Host "Masked runner public IP"
            }
          } catch {
            Write-Host "Could not determine public IP for masking (non-critical)"
          }

      - name: Generate image names
        id: names
        shell: pwsh
        run: |
          $ImageName = "algo-runner-win22-$(Get-Date -Format 'yyyyMMdd.HHmm')"
          $ImageVersion = "1.$(Get-Date -Format 'yyyyMMdd.HHmm')"
          # Generate temp RG name: base-temp-<random6>
          $randomSuffix = -join ((48..57) + (97..122) | Get-Random -Count 6 | ForEach-Object {[char]$_})
          $TempRgName = "${{ vars.AZURE_RESOURCE_GROUP }}-temp-$randomSuffix"
          "image_name=$ImageName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "image_version=$ImageVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "temp_rg_name=$TempRgName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "::notice::Image name: $ImageName, Version: $ImageVersion"
          Write-Host "::notice::Temp RG: $TempRgName"

      - name: Generate install password
        id: password
        shell: pwsh
        run: |
          # Generate a secure random password
          $bytes = New-Object byte[] 24
          [System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes($bytes)
          $password = [Convert]::ToBase64String($bytes) -replace '[/+=]',''
          $password = $password.Substring(0, [Math]::Min(24, $password.Length)) + "Aa1!"
          Write-Host "::add-mask::$password"
          "password=$password" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Packer Init
        shell: pwsh
        working-directory: ${{ env.TEMPLATE_PATH }}
        run: |
          Write-Host "Initializing Packer plugins..."
          packer init .
          if ($LASTEXITCODE -ne 0) { throw "Packer init failed" }

      - name: Build Managed Image
        id: build
        shell: pwsh
        working-directory: ${{ env.TEMPLATE_PATH }}
        env:
          PKR_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          PKR_VAR_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          PKR_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          PKR_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          PKR_VAR_managed_image_resource_group_name: ${{ vars.AZURE_RESOURCE_GROUP }}
          PKR_VAR_location: ${{ vars.AZURE_LOCATION }}
          PKR_VAR_managed_image_name: ${{ steps.names.outputs.image_name }}
          PKR_VAR_image_os: ${{ env.IMAGE_OS }}
          PKR_VAR_install_password: ${{ steps.password.outputs.password }}
          PKR_VAR_gallery_name: ${{ vars.AZURE_GALLERY_NAME }}
          PKR_VAR_gallery_resource_group_name: ${{ vars.AZURE_RESOURCE_GROUP }}
          PKR_VAR_gallery_image_name: ${{ vars.AZURE_GALLERY_IMAGE_NAME }}
          PKR_VAR_gallery_image_version: ${{ steps.names.outputs.image_version }}
          PKR_VAR_gallery_storage_account_type: ${{ vars.GALLERY_STORAGE_ACCOUNT_TYPE }}
          PKR_VAR_bc_country: ${{ inputs.bc_country }}
          PKR_VAR_bc_type: ${{ inputs.bc_type }}
          PKR_VAR_bc_select: ${{ inputs.bc_select }}
          PKR_VAR_bc_cache_skip: ${{ inputs.skip_bc_cache }}
          PKR_VAR_vm_size: "Standard_D4s_v3"
          PKR_VAR_temp_resource_group_name: ${{ steps.names.outputs.temp_rg_name }}
        run: |
          Write-Host "Building AL-Go runner image..."
          Write-Host "   -> Image Name: ${{ steps.names.outputs.image_name }}"
          Write-Host "   -> Image Version: ${{ steps.names.outputs.image_version }}"
          Write-Host "   -> Temp RG: ${{ steps.names.outputs.temp_rg_name }}"
          Write-Host "   -> BC Type: ${{ inputs.bc_type }}"
          Write-Host "   -> BC Country: ${{ inputs.bc_country }}"

          packer build `
            -only="windows-2022-algo.azure-arm.image" `
            -color=false `
            -on-error=abort `
            .

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Packer build failed"
            exit 1
          }

          Write-Host "Build completed successfully!"

      - name: Upload software report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: software-report
          path: |
            images/windows/Windows2022-ALGo-Readme.md
            images/windows/software-report-algo.json
          retention-days: 90
          if-no-files-found: warn

  # ============================================================================
  # Job 2: Verify Gallery Image
  # ============================================================================
  verify-gallery:
    name: Verify Gallery Image
    needs: build-image
    runs-on: self-hosted
    timeout-minutes: 10
    if: success()

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Verify gallery image version
        shell: pwsh
        run: |
          Write-Host "Verifying image creation in Azure Compute Gallery..."
          az sig image-version show `
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" `
            --gallery-name "${{ vars.AZURE_GALLERY_NAME }}" `
            --gallery-image-definition "${{ vars.AZURE_GALLERY_IMAGE_NAME }}" `
            --gallery-image-version "${{ needs.build-image.outputs.image_version }}" `
            --query "{id:id, provisioningState:provisioningState, publishingProfile:publishingProfile}" `
            --output table

          Write-Host "Image verified in gallery!"

      - name: List recent versions
        shell: pwsh
        run: |
          Write-Host "Recent gallery versions:"
          az sig image-version list `
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" `
            --gallery-name "${{ vars.AZURE_GALLERY_NAME }}" `
            --gallery-image-definition "${{ vars.AZURE_GALLERY_IMAGE_NAME }}" `
            --query "[].{Version:name, Created:publishingProfile.publishedDate, State:provisioningState}" `
            --output table

  # ============================================================================
  # Job 3: Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [build-image, verify-gallery]
    runs-on: self-hosted
    if: success()
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download software report
        uses: actions/download-artifact@v4
        with:
          name: software-report
          path: ./artifacts
        continue-on-error: true

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: "v${{ needs.build-image.outputs.image_version }}"
          name: "AL-Go Runner Image v${{ needs.build-image.outputs.image_version }}"
          body: |
            ## AL-Go Runner Image Release

            **Image Version:** ${{ needs.build-image.outputs.image_version }}
            **Image Name:** ${{ needs.build-image.outputs.image_name }}
            **Gallery:** ${{ vars.AZURE_GALLERY_NAME }}
            **Definition:** ${{ vars.AZURE_GALLERY_IMAGE_NAME }}

            ### BC Configuration
            - **Type:** ${{ inputs.bc_type }}
            - **Country:** ${{ inputs.bc_country }}
            - **Version:** ${{ inputs.bc_select }}
            - **Cache Skipped:** ${{ inputs.skip_bc_cache }}

            ### What's Included
            - Windows Server 2022 Datacenter (Hyper-V Gen 1)
            - Docker with Windows containers
            - BcContainerHelper module
            - Pre-cached BC artifacts and Docker image
            - .NET 8.0 SDK
            - Git, Azure CLI, PowerShell 7
            - Node.js 20 LTS

            ### Usage
            Deploy from Azure Compute Gallery:
            ```
            ${{ vars.AZURE_GALLERY_NAME }}/${{ vars.AZURE_GALLERY_IMAGE_NAME }}/${{ needs.build-image.outputs.image_version }}
            ```

            ### Performance
            - BC container startup: < 2 minutes (vs 30-45 min on GitHub-hosted runners)
            - Image size: ~35-40GB (vs 100GB+ full runner-images)
          draft: false
          prerelease: false

      - name: Output Summary
        shell: pwsh
        run: |
          "## Image Build Complete!" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| Property | Value |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "|----------|-------|" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| **Image Name** | ${{ needs.build-image.outputs.image_name }} |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| **Image Version** | ${{ needs.build-image.outputs.image_version }} |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| **Gallery** | ${{ vars.AZURE_GALLERY_NAME }} |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          "| **Resource Group** | ${{ vars.AZURE_RESOURCE_GROUP }} |" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

  # ============================================================================
  # Job 4: Cleanup Temp Resources (runs on failure/cancellation)
  # ============================================================================
  cleanup:
    name: Cleanup Temp Resources
    needs: build-image
    runs-on: self-hosted
    if: always() && needs.build-image.outputs.temp_rg_name != ''
    timeout-minutes: 10

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Delete temp resource group if exists
        shell: pwsh
        run: |
          $tempRgName = "${{ needs.build-image.outputs.temp_rg_name }}"
          Write-Host "Checking for temp resource group: $tempRgName"

          $rgExists = az group exists --name $tempRgName
          if ($rgExists -eq "true") {
            Write-Host "Deleting temp resource group: $tempRgName"
            az group delete --name $tempRgName --yes --no-wait
            Write-Host "Deletion initiated (async)"
          } else {
            Write-Host "Temp resource group not found (already cleaned up by Packer)"
          }
